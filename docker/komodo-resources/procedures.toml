[[procedure]]
name = "Backup Core Database"
description = "Triggers the Core database backup at the scheduled time"
tags = ["system"]
config.schedule = "Every day at 01:00"
config.schedule_alert = true
config.failure_alert = true

[[procedure.config.stage]]
name = "Backup"
executions = [
  { execution.type = "BackupCoreDatabase", execution.params = {} }
]

[[procedure]]
name = "Rebuild Periphery Image"
description = "Rebuild custom periphery with latest upstream base image"
tags = ["system", "periphery"]
config.schedule = "Every day at 04:00"

[[procedure.config.stage]]
name = "Build"
executions = [
  { execution.type = "RunBuild", execution.params.build = "periphery-custom" }
]

[[procedure]]
name = "Global Auto Update"
description = "Auto-update stacks and deployments"
tags = ["system"]
config.schedule = "Every day at 05:00"

[[procedure.config.stage]]
name = "Update All"
executions = [
  { execution.type = "GlobalAutoUpdate", execution.params = {} }
]

[[procedure]]
name = "deploy-all-stacks"
description = "Deploy all stacks if changed"
tags = ["deploy"]

[[procedure.config.stage]]
name = "Infrastructure First"
executions = [
  { execution.type = "DeployStack", execution.params.stack = "traefik" },
]

[[procedure.config.stage]]
name = "Applications"
executions = [
  { execution.type = "BatchDeployStackIfChanged", execution.params.pattern = "*", execution.params.exclude_pattern = "komodo-core|aegis-pangolin|aegis-newt|aegis-periphery|aegis-pangolin-client" },
]

[[procedure]]
name = "deploy-vps-infra"
description = "Deploy VPS infrastructure stacks in correct order (gateway → pangolin → newt → periphery → identity + monitoring)"
tags = ["deploy", "racknerd-aegis"]

[[procedure.config.stage]]
name = "Gateway"
executions = [
  { execution.type = "DeployStack", execution.params.stack = "aegis-gateway" },
]

[[procedure.config.stage]]
name = "Pangolin"
executions = [
  { execution.type = "DeployStack", execution.params.stack = "aegis-pangolin" },
]

[[procedure.config.stage]]
name = "Tunnel Agent"
executions = [
  { execution.type = "DeployStack", execution.params.stack = "aegis-newt" },
]

[[procedure.config.stage]]
name = "Management Agent"
executions = [
  { execution.type = "DeployStack", execution.params.stack = "aegis-periphery" },
]

[[procedure.config.stage]]
name = "Observability Tunnel"
executions = [
  { execution.type = "DeployStack", execution.params.stack = "aegis-pangolin-client" },
]

[[procedure.config.stage]]
name = "Identity and Monitoring"
executions = [
  { execution.type = "DeployStack", execution.params.stack = "aegis-identity" },
  { execution.type = "DeployStack", execution.params.stack = "racknerd-aegis-alloy" },
]
